<!doctype html>
<html>
  <head>
      <meta charset=utf-8>
      <title>Web Wish 7: Custom Element Disconnected Signal</title>
      <style>@layer reset, default, layout;</style>
      <link rel=stylesheet href=/assets/css/reset.css>
      <link rel=stylesheet href=/assets/css/fonts.css>
      <link rel=stylesheet href=/assets/css/default.css>
      <link rel=stylesheet href=/assets/css/layout.css>
      <link rel=stylesheet href=/assets/css/style.css>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel=canonical href="https://odland.dev/2024/12/07/web-wish-7-custom-element-disconnected-signal.html">
      <meta http-equiv="refresh" content="0; url=https://odland.dev/2024/12/07/web-wish-7-custom-element-disconnected-signal.html" />
      <link rel="me" href="https://front-end.social/@johannes">
  </head>
  <body>
  
   <header>
      <a href="/" class="site-title">Johannes Odland</a>
      <nav></nav>
    </header>

    <article role="main">
      <header>
        <time datetime="Sat Dec 07 2024 19:30:00 GMT+0000 (Coordinated Universal Time)" pubdate>
          Dec 7, 2024
        </time>
        <h1>Web Wish 7: Custom Element Disconnected Signal</h1>
      </header>
      <div class="content"><p>Managing lifecycles in custom elements can be tedious.
For instance, any event listener on global objects added in <code>connectedCallback()</code> must be removed in <code>disconnectedCallback()</code>.</p>
<p>This double bookkeeping is error-prone, and could be simpler.
Using an <code>AbortController</code> can simplify things by automatically removing event listeners when the <code>abort()</code> method is called.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">SomeElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  #abortController
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#abortController<span class="token operator">?.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#abortController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">signal</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#abortController<span class="token punctuation">.</span>signal <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">disconnectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>#abortController<span class="token operator">?.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This process would be much cleaner if the HTMLElement offered a built-in <code>disconnectedSignal()</code>.
Luckily, <a href="https://indieweb.social/@keithamus">Keith Cirkel</a> <a href="https://github.com/whatwg/dom/issues/1296">has proposed such a signal</a>.</p>
<p>With this proposal, the example above would become:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">SomeElement</span> <span class="token keyword">extends</span> <span class="token class-name">HTMLElement</span> <span class="token punctuation">{</span>
  <span class="token function">connectedCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">signal</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">disconnectedSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This Christmas, I'm wishing for a <code>disconnectedSignal()</code> method to automatically remove event listeners
when an element is disconnected.</p>
<p>Relevant issues and PRs:</p>
<ul>
<li><a href="https://github.com/whatwg/dom/issues/1296">Provide an AbortSignal that aborts when Nodes become disconnected</a></li>
</ul>
</div>
    </article>
  
    <footer>
      <h2>Johannes Odland</h2>
      <p>Infrequent posts about CSS and other frontend stuff.</p>
      <ul>
        <li><a href="https://front-end.social/@johannes">Mastodon</a></li>
        <li><a href="https://github.com/johannesodland">Github</a></li>
        <li><a href="/feed.xml">Atom feed</a></li>
      </ul>
      <p>Built with <a href="https://www.11ty.dev">Eleventy</a>.</p>
    </footer>
  </body>
</html>